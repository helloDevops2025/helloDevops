name: Build Frontend and Run Cypress Tests

on:
  push:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  e2e-test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: ecommerce
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost -uroot -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # âœ… à¸£à¸±à¸™ MySQL readiness check
      - name: Wait for MySQL to be ready
        run: |
          echo "â³ Waiting for MySQL..."
          for i in {1..10}; do
            if mysql -h 127.0.0.1 -uroot -proot -e "SELECT 1" >/dev/null 2>&1; then
              echo "âœ… MySQL is ready!"
              exit 0
            fi
            echo "âŒ Retry ($i/10)..."
            sleep 5
          done
          exit 1
          
      - name: Login to Docker Hub
        run: echo ${{ secrets.DOCKER_TOKEN }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

      # âœ… à¸”à¸¶à¸‡ backend à¸ˆà¸²à¸ Docker Hub
      - name: Pull backend image
        run: docker pull u6687032/hello-devops-backend:latest

      # âœ… à¸£à¸±à¸™ backend container
      - name: Run backend container
        run: |
          docker run -d --name backend \
            -p 8080:8080 \
            -e SPRING_DATASOURCE_URL=jdbc:mysql://127.0.0.1:3306/testdb \
            -e SPRING_DATASOURCE_USERNAME=root \
            -e SPRING_DATASOURCE_PASSWORD=root \
            u6687032/hello-devops-backend:latest

      # âœ… Install Node.js + dependencies
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm install

      # âœ… Run Cypress tests (frontend + backend à¸žà¸£à¹‰à¸­à¸¡)
      # - name: Run Cypress E2E tests
      #   uses: cypress-io/github-action@v6
      #   with:
      #     working-directory: ./frontend
      #     start: npm run dev
      #     wait-on: 'http://localhost:5173'
      #     browser: chrome
      #     headless: true

  # build:
  #  runs-on: ubuntu-latest
  #  needs: e2e-test
  #  steps:
  #     # âœ… Build frontend for deploy
  #     - name: Build frontend
  #       working-directory: ./frontend
  #       run: npm run build
        
  Docker:
   runs-on: ubuntu-latest
   needs: e2e-test
   steps:
      # ðŸ³ Build Docker image à¹à¸¥à¸°à¹€à¸à¹‡à¸š log
      - name: Build Docker image
        working-directory: /frontend
        run: |
          echo "ðŸ³ Building Docker image..." | tee -a reports/docker_build_log.txt
          docker build -t hello-devops-frontend:latest ./frontend 2>&1 | tee -a reports/docker_build_log.txt

      # ðŸ” Login Docker Hub
      - name: Login to Docker Hub
        run: echo dckr_pat_VJu4lYTGkJU9meYspQ3U2XkUjW4 | docker login -u u6687032 --password-stdin

      # ðŸ“¦ Push image à¹à¸¥à¸°à¹€à¸à¹‡à¸š log
      - name: Push image to Docker Hub
        if: success()
        run: |
          echo "ðŸš€ Pushing image to Docker Hub..." | tee -a reports/docker_build_log.txt
          docker tag hello-devops-frontend:latest u6687032/hello-devops-frontend:latest
          docker push u6687032/hello-devops-frontend:latest 2>&1 | tee -a reports/docker_build_log.txt

      # âœ… à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹€à¸›à¹‡à¸™ artifact
      - name: Upload reports to GitHub
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-reports
          path: reports/

