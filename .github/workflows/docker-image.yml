name: Build Frontend, Run Cypress Tests snd Deploy to Docker

on:
  push:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  e2e-test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: ecommerce
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost -uroot -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ‚úÖ ‡∏£‡∏±‡∏ô MySQL readiness check
      - name: Wait for MySQL to be ready
        run: |
          echo "‚è≥ Waiting for MySQL..."
          for i in {1..10}; do
            if mysql -h 127.0.0.1 -uroot -proot -e "SELECT 1" >/dev/null 2>&1; then
              echo "‚úÖ MySQL is ready!"
              exit 0
            fi
            echo "‚ùå Retry ($i/10)..."
            sleep 5
          done
          exit 1
          
      - name: Login to Docker Hub
        run: echo ${{ secrets.DOCKER_TOKEN }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

      # ‚úÖ ‡∏î‡∏∂‡∏á backend ‡∏à‡∏≤‡∏Å Docker Hub
      - name: Pull backend image
        run: docker pull u6687032/hello-devops-backend:latest

      # ‚úÖ ‡∏£‡∏±‡∏ô backend container
      - name: Run backend container
        run: |
          docker run -d --name backend \
            -p 8080:8080 \
            -e SPRING_DATASOURCE_URL=jdbc:mysql://127.0.0.1:3306/testdb \
            -e SPRING_DATASOURCE_USERNAME=root \
            -e SPRING_DATASOURCE_PASSWORD=root \
            u6687032/hello-devops-backend:latest

      # ‚úÖ Install Node.js + dependencies
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: |
          ls
          pwd
          npm install

      # # ‚úÖ Run Cypress tests (frontend + backend ‡∏û‡∏£‡πâ‡∏≠‡∏°)
      # - name: Run Cypress E2E tests
      #   uses: cypress-io/github-action@v6
      #   with:
      #     working-directory: ./frontend
      #     start: npm run dev
      #     wait-on: 'http://localhost:5173'
      #     browser: chrome
      #     headless: true

  # build:
  #  runs-on: ubuntu-latest
  #  needs: e2e-test
  #  steps:
  #     # ‚úÖ Build frontend for deploy
  #     - name: Build frontend
  #       working-directory: ./frontend
  #       run: npm run build
        
  Docker:
   runs-on: ubuntu-latest
   needs: e2e-test
   outputs:
      TAG: ${{ steps.set_tag.outputs.TAG }}   # ‚úÖ ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÉ‡∏´‡πâ job ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ
      
   steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate package-lock.json if missing
        working-directory: ./frontend
        run: |
          if [ ! -f package-lock.json ]; then
            npm install
          fi
      
      # ‡∏ï‡∏±‡πâ‡∏á tag ‡∏à‡∏≤‡∏Å commit SHA
      - name: Set build tag
        id: set_tag
        run: echo "TAG=${GITHUB_SHA::7}" >> $GITHUB_ENV
             echo "TAG=$TAG" >> $GITHUB_OUTPUT

      # Build Docker image
      - name: Build Docker image
        run: |
          cd frontend
          docker build -t u6687032/hello-devops-frontend:${{ env.TAG }} .

      # üîê Login Docker Hub
      - name: Login to Docker Hub
        run: echo ${{ secrets.DOCKER_TOKEN }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

      # üì¶ Push image ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö log
      - name: Push image to Docker Hub
        if: success()
        run: |
          echo "üöÄ Pushing image to Docker Hub..." 
          docker push u6687032/hello-devops-frontend:${{ env.TAG }}
          docker tag u6687032/hello-devops-frontend:${{ env.TAG }} u6687032/hello-devops-frontend:latest
          docker push u6687032/hello-devops-frontend:latest
  Deploy:
   runs-on: ubuntu-latest
   needs: Docker
   env:
      TAG: ${{ needs.Docker.outputs.TAG }}   # ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å job build
      PROJECT_ID: hellodevops-476816
      CLUSTER_NAME: hello-devops-cluster
      REGION: asia-northeast1
      DEPLOYMENT_NAME: backend
      
   steps:
      # 1Ô∏è‚É£ Authenticate to Google Cloud
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
  
      # 2Ô∏è‚É£ Get GKE credentials (‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö cluster)
      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.CLUSTER_NAME }}
          location: ${{ env.REGION }}
          project_id: ${{ env.PROJECT_ID }}
          
      # ‚úÖ 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ConfigMap ‡∏à‡∏≤‡∏Å init.sql (‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)
      - name: Update MySQL init ConfigMap
        run: |
          kubectl delete configmap mysql-initdb --ignore-not-found
          kubectl create configmap mysql-initdb --from-file=init.sql=./init.sql
          kubectl get configmap mysql-initdb

      - name: Debug TAG value
        run: 'echo "üîé Current TAG value: ${{ env.TAG }}"'
        
      # Update image to specific version (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ tag ‡πÄ‡∏â‡∏û‡∏≤‡∏∞)
      - name: Update Deployment frontend images
        if: env.TAG != ''
        run: |
          echo "üîÑ Updating deployments to tag: ${{ env.TAG }}"
          kubectl set image deployment/frontend-deployment frontend=u6687032/hello-devops-frontend:${{ env.TAG }}
          kubectl rollout status deployment/frontend-deployment
  
